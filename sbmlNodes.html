<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>SBML Nodes</title>
<!--
    <script src="http://d3js.org/d3.v2.js"></script>
-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script> 
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            var str;
            var sbmlDoc;
            var $sbmlDoc;
              
            $("myCanvas").hide("slow");
            $("p").click(function(){
                $(this).hide("slow");
            });
            
            // adding nodes
                
            var width = 960,
            height = 500;
        
            var color = d3.scale.category20();
            
            var force = d3.layout.force()
                .charge(-120)
                .linkDistance(30)
                .size([width, height]);
            
            var svg = d3.select("#chart").append("svg")
                .attr("width", width)
                .attr("height", height);
            
            var sbmlString = '<?xml version="1.0" encoding="UTF-8"?> <sbml xmlns="http://www.sbml.org/sbml/level2/version4" level="2" version="4"> <model metaid="_case00001" id="case00001" name="case00001"> <listOfCompartments> <compartment id="compartment" name="compartment" size="1" units="volume"/> </listOfCompartments> <listOfSpecies> <species id="S1" name="S1" compartment="compartment" initialAmount="0.00015" substanceUnits="substance"/> <species id="S2" name="S2" compartment="compartment" initialAmount="0" substanceUnits="substance"/> </listOfSpecies> <listOfParameters> <parameter id="k1" name="k1" value="1"/> </listOfParameters> <listOfReactions> <reaction id="reaction1" name="reaction1" reversible="false" fast="false"> <listOfReactants> <speciesReference species="S1"/> </listOfReactants> <listOfProducts> <speciesReference species="S2"/> </listOfProducts> <kineticLaw> <math xmlns="http://www.w3.org/1998/Math/MathML"> <apply> <times/> <ci> compartment </ci> <ci> k1 </ci> <ci> S1 </ci> </apply> </math> </kineticLaw> </reaction> </listOfReactions> </model> </sbml>' ;
            
            sbmlDoc = $.parseXML(sbmlString);
            $sbmlDoc = $(sbmlDoc);

            $sbmlDoc.each(function(index) {
                alert(index + ': ' + $(this).text());
            });
            data = [{name:"A", value:20}, {name:"B", value:30}];
            
            force
                .nodes(data)
                .links([])
                .start();
                
            var link = svg.selectAll("line.link")
              .data(data)
            .enter().append("line")
              .attr("class", "link")
              .style("stroke-width", function(d) { return Math.sqrt(d.value); });
            
            var node = svg.selectAll("circle.node")
              .data(data)
            .enter().append("circle")
              .attr("class", "node")
              .attr("r", function(d) { return d.value; })
              .style("fill", function(d) { return color(d.group); })
              .call(force.drag);
            
            node.append("title")
              .text(function(d) { return d.name; });
            
            force.on("tick", function() {
//            link.attr("x1", function(d) { return d.source.x; })
//                .attr("y1", function(d) { return d.source.y; })
//                .attr("x2", function(d) { return d.target.x; })
//                .attr("y2", function(d) { return d.target.y; });
//            
            node.attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
            });
                
            
            d3.json("miserables.json", function(json) {
                force
                    .nodes(json.nodes)
                    .links(json.links)
                    .start();
                    
                var link = svg.selectAll("line.link")
                  .data(json.links)
                .enter().append("line")
                  .attr("class", "link")
                  .style("stroke-width", function(d) { return Math.sqrt(d.value); });
                
                var node = svg.selectAll("circle.node")
                  .data(json.nodes)
                .enter().append("circle")
                  .attr("class", "node")
                  .attr("r", 5)
                  .style("fill", function(d) { return color(d.group); })
                  .call(force.drag);
                
                node.append("title")
                  .text(function(d) { return d.name; });
                
                force.on("tick", function() {
                link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });
                
                node.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
                });
            });
            
            $("button").click(function(){
                str = $("textarea").val();
    
                $("textarea").hide("slow");
                $(this).hide("slow");
                $("myCanvas").show("slow");
                
                sbmlDoc = $.parseXML(str);
                $sbmlDoc = $(sbmlDoc);
                
                $("#inputText").append("<br>Number of compartments in your SBML model: " + $sbmlDoc.find("compartment").length + "</br>");
                
                
                
            });
            
      
            // $sbmlDoc.find("compartment").length // Gets number of compartments in SBML
          });
    </script>
  </head>
  <body>
    <p>This is text</p>    
    <textarea rows="10" cols="30">Input SBML Here</textarea>
    <br/>
    <button type="button">Input SBML</button>
    <br/>
    <canvas id="myCanvas" width="200" height="100"></canvas>
    <br/>
    <div id="chart"></div>
    <br/>
    <p id="inputText"></p>
</body>
</html>